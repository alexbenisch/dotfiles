#!/bin/bash

set -euo pipefail

XDG_CONFIG_HOME="$HOME/.config"

if ! command -v zsh >/dev/null; then
  if command -v apt >/dev/null; then
    sudo apt update && sudo apt install -y zsh
  elif command -v yum >/dev/null; then
    sudo yum install -y zsh
  elif command -v dnf >/dev/null; then
    sudo dnf install -y zsh
  elif command -v pacman >/dev/null; then
    sudo pacman -S --noconfirm zsh
  elif command -v brew >/dev/null; then
    brew install zsh
  else
    echo "Package manager not found. Please install zsh manually."
    exit 1
  fi
fi

if command -v zsh >/dev/null; then
  sudo chsh -s "$(command -v zsh)" "$USER"
fi

# Install and configure locales for Debian-based systems
if ! locale -a | grep -q "en_US.utf8\|en_US.UTF-8" && command -v apt >/dev/null; then
  sudo apt update && sudo apt install -y locales
  sudo locale-gen en_US.UTF-8
  sudo update-locale LANG=en_US.UTF-8
fi

if ! command -v chezmoi >/dev/null; then
  sh -c "$(curl -fsLS get.chezmoi.io)" -- init --apply https://github.com/alexbenisch/dotfiles
fi

if [ ! -d "$HOME/.zsh" ]; then
  mkdir -p "$HOME/.zsh"
fi

if [ ! -d "$HOME/.zsh/pure" ]; then
  git clone https://github.com/sindresorhus/pure.git "$HOME/.zsh/pure"
fi

if ! command -v fzf >/dev/null; then
  if command -v apt >/dev/null; then
    sudo apt update && sudo apt install -y fzf
  elif command -v yum >/dev/null; then
    sudo yum install -y fzf
  elif command -v dnf >/dev/null; then
    sudo dnf install -y fzf
  elif command -v pacman >/dev/null; then
    sudo pacman -S --noconfirm fzf
  elif command -v brew >/dev/null; then
    brew install fzf
  else
    echo "Package manager not found. Please install fzf manually."
    exit 1
  fi
fi

if command -v alacritty >/dev/null; then
  mkdir -p "$XDG_CONFIG_HOME"/alacritty/themes
  git clone https://github.com/alacritty/alacritty-theme "$XDG_CONFIG_HOME"/alacritty/themes
fi

# Install tmux if not present
if ! command -v tmux >/dev/null; then
  if command -v apt >/dev/null; then
    sudo apt update && sudo apt install -y tmux
  elif command -v yum >/dev/null; then
    sudo yum install -y tmux
  elif command -v dnf >/dev/null; then
    sudo dnf install -y tmux
  elif command -v pacman >/dev/null; then
    sudo pacman -S --noconfirm tmux
  elif command -v brew >/dev/null; then
    brew install tmux
  else
    echo "Package manager not found. Please install tmux manually."
    exit 1
  fi
fi

# Validate tmux configuration and install tpm if needed
if command -v tmux >/dev/null; then
  mkdir -p "$XDG_CONFIG_HOME"/tmux/plugins
  
  # Check if tpm is installed
  if [ ! -d "$XDG_CONFIG_HOME/tmux/plugins/tpm" ]; then
    echo "Installing tmux plugin manager (tpm)..."
    git clone https://github.com/tmux-plugins/tpm "$XDG_CONFIG_HOME"/tmux/plugins/tpm
    
    # Install plugins if tmux config exists
    if [ -f "$XDG_CONFIG_HOME/tmux/tmux.conf" ]; then
      echo "Installing tmux plugins..."
      "$XDG_CONFIG_HOME"/tmux/plugins/tpm/bin/install_plugins
    fi
  fi
fi

exit 0
