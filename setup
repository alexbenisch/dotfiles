#!/bin/bash

set -euo pipefail

XDG_CONFIG_HOME="$HOME/.config"
DOTFILES_SOURCE="$HOME/.local/share/dotfiles"

# Start ssh-agent if not running (prevents passphrase prompts in devcontainers)
if [ -z "$SSH_AUTH_SOCK" ]; then
  # Check if any SSH key exists
  if ls ~/.ssh/id_* >/dev/null 2>&1; then
    echo "üîë Starting ssh-agent..."
    eval "$(ssh-agent -s)" > /dev/null 2>&1
    # Try to add the default key
    ssh-add 2>/dev/null || true
    echo "‚úÖ ssh-agent started"
  fi
fi

# Function to install and make tools available system-wide
install_system_tool() {
  local tool_name="$1"
  local install_command="$2"

  if ! command -v "$tool_name" >/dev/null 2>&1; then
    echo "üì¶ Installing $tool_name system-wide..."

    # Create temp directory for installation
    local temp_dir=$(mktemp -d)
    cd "$temp_dir"

    # Run the install command
    eval "$install_command"

    # Find the installed binary
    local binary_path=""
    if [ -f "$HOME/bin/$tool_name" ]; then
      binary_path="$HOME/bin/$tool_name"
    elif [ -f "$HOME/.local/bin/$tool_name" ]; then
      binary_path="$HOME/.local/bin/$tool_name"
    elif [ -f "./bin/$tool_name" ]; then
      binary_path="./bin/$tool_name"
    fi

    if [ -n "$binary_path" ] && [ -f "$binary_path" ]; then
      # Install to system-wide location
      sudo cp "$binary_path" /usr/local/bin/
      sudo chmod +x /usr/local/bin/"$tool_name"
      echo "‚úÖ $tool_name installed to /usr/local/bin (available for all users)"
    else
      echo "‚ö†Ô∏è  $tool_name binary not found in expected locations, checking if already in PATH..."
      if command -v "$tool_name" >/dev/null 2>&1; then
        echo "‚úÖ $tool_name is available in PATH"
      else
        echo "‚ùå Failed to install $tool_name"
        cd - >/dev/null
        rm -rf "$temp_dir"
        return 1
      fi
    fi

    cd - >/dev/null
    rm -rf "$temp_dir"
  else
    echo "‚úÖ $tool_name already installed"
  fi
}

echo "üöÄ Setting up dotfiles..."

# Ensure chezmoi is available system-wide
install_system_tool "chezmoi" 'sh -c "$(curl -fsLS get.chezmoi.io)"'

# Configure chezmoi to use this dotfiles directory as source
echo "‚öôÔ∏è  Configuring chezmoi..."
mkdir -p "$HOME/.config/chezmoi"
cat > "$HOME/.config/chezmoi/chezmoi.toml" <<EOF
# Chezmoi configuration
# Use ~/.local/share/dotfiles as the source directory
sourceDir = "$DOTFILES_SOURCE"
EOF
echo "‚úÖ Chezmoi configured to use $DOTFILES_SOURCE"

# Ensure mise is available system-wide
install_system_tool "mise" 'curl https://mise.run | sh'

# Install system dependencies for development tools
echo "üì¶ Installing system dependencies..."
if command -v apt >/dev/null; then
  # libatomic is required for Node.js on some systems
  # build-essential provides gcc and other build tools needed by mise
  sudo apt update && sudo apt install -y libatomic1 build-essential
  echo "‚úÖ System dependencies installed (libatomic1, build-essential)"
elif command -v yum >/dev/null; then
  sudo yum install -y libatomic gcc gcc-c++ make
  echo "‚úÖ System dependencies installed"
elif command -v dnf >/dev/null; then
  sudo dnf install -y libatomic gcc gcc-c++ make
  echo "‚úÖ System dependencies installed"
elif command -v pacman >/dev/null; then
  sudo pacman -S --noconfirm base-devel
  echo "‚úÖ System dependencies installed"
elif command -v apk >/dev/null; then
  sudo apk update && sudo apk add libatomic build-base
  echo "‚úÖ System dependencies installed (libatomic, build-base)"
fi

# Install zsh if not present
if ! command -v zsh >/dev/null; then
  echo "üì¶ Installing zsh..."
  if command -v apt >/dev/null; then
    sudo apt update && sudo apt install -y zsh
  elif command -v yum >/dev/null; then
    sudo yum install -y zsh
  elif command -v dnf >/dev/null; then
    sudo dnf install -y zsh
  elif command -v pacman >/dev/null; then
    sudo pacman -S --noconfirm zsh
  elif command -v apk >/dev/null; then
    sudo apk update && sudo apk add zsh
  elif command -v brew >/dev/null; then
    brew install zsh
  else
    echo "‚ö†Ô∏è  Package manager not found. Please install zsh manually."
    exit 1
  fi
  echo "‚úÖ Zsh installed"
fi

# Set zsh as default shell if available
if command -v zsh >/dev/null; then
  if [ "$SHELL" != "$(command -v zsh)" ]; then
    echo "üìù Setting zsh as default shell..."
    sudo chsh -s "$(command -v zsh)" "$USER"
    echo "‚úÖ Zsh set as default shell (restart terminal to take effect)"
  fi
fi

# Install and configure locales for Debian-based systems
if ! locale -a | grep -q "en_US.utf8\|en_US.UTF-8" && command -v apt >/dev/null; then
  echo "üåç Configuring locales..."
  sudo apt update && sudo apt install -y locales
  sudo locale-gen en_US.UTF-8
  sudo update-locale LANG=en_US.UTF-8
  echo "‚úÖ Locales configured"
fi

# chezmoi is now installed system-wide by install_system_tool function above

# Install Antigen plugin manager for zsh
# Antigen is required by .zshrc to manage zsh plugins
# Without this, you'll get: "source: no such file or directory: ~/.antigen/antigen.zsh"
# Antigen will auto-install configured plugins (including oh-my-zsh bundles) on first zsh launch
if [ ! -d "$HOME/.antigen" ]; then
  echo "üîå Installing Antigen plugin manager..."
  mkdir -p "$HOME/.antigen"
  curl -L git.io/antigen > "$HOME/.antigen/antigen.zsh"
  echo "‚úÖ Antigen installed"
fi

# Setup Zsh Pure prompt
if [ ! -d "$HOME/.zsh" ]; then
  echo "üìÅ Creating ~/.zsh directory..."
  mkdir -p "$HOME/.zsh"
fi

if [ ! -d "$HOME/.zsh/pure" ]; then
  echo "üé® Installing Pure prompt theme..."
  git clone https://github.com/sindresorhus/pure.git "$HOME/.zsh/pure"
  echo "‚úÖ Pure prompt installed"
fi

# Install fzf if not available (fallback to system packages)
if ! command -v fzf >/dev/null; then
  echo "üîç Installing fzf..."
  if command -v apt >/dev/null; then
    sudo apt update && sudo apt install -y fzf
  elif command -v yum >/dev/null; then
    sudo yum install -y fzf
  elif command -v dnf >/dev/null; then
    sudo dnf install -y fzf
  elif command -v pacman >/dev/null; then
    sudo pacman -S --noconfirm fzf
  elif command -v apk >/dev/null; then
    sudo apk update && sudo apk add fzf
  elif command -v brew >/dev/null; then
    brew install fzf
  else
    echo "‚ö†Ô∏è  Package manager not found for fzf. Will try via mise."
  fi
fi

# Setup Alacritty themes if Alacritty is installed
if command -v alacritty >/dev/null; then
  if [ ! -d "$XDG_CONFIG_HOME/alacritty/themes" ]; then
    echo "üé® Installing Alacritty themes..."
    mkdir -p "$XDG_CONFIG_HOME"/alacritty/themes
    git clone https://github.com/alacritty/alacritty-theme "$XDG_CONFIG_HOME"/alacritty/themes
    echo "‚úÖ Alacritty themes installed"
  fi
fi

# Install tmux if not present
if ! command -v tmux >/dev/null; then
  echo "üñ•Ô∏è  Installing tmux..."
  if command -v apt >/dev/null; then
    sudo apt update && sudo apt install -y tmux
  elif command -v yum >/dev/null; then
    sudo yum install -y tmux
  elif command -v dnf >/dev/null; then
    sudo dnf install -y tmux
  elif command -v pacman >/dev/null; then
    sudo pacman -S --noconfirm tmux
  elif command -v apk >/dev/null; then
    sudo apk update && sudo apk add tmux
  elif command -v brew >/dev/null; then
    brew install tmux
  else
    echo "‚ö†Ô∏è  Package manager not found for tmux. Please install manually."
  fi
fi

# Validate tmux configuration and install tpm if needed
if command -v tmux >/dev/null; then
  mkdir -p "$XDG_CONFIG_HOME"/tmux/plugins

  # Check if tpm is installed
  if [ ! -d "$XDG_CONFIG_HOME/tmux/plugins/tpm" ]; then
    echo "üîå Installing tmux plugin manager (tpm)..."
    git clone https://github.com/tmux-plugins/tpm "$XDG_CONFIG_HOME"/tmux/plugins/tpm

    # Install plugins if tmux config exists
    if [ -f "$XDG_CONFIG_HOME/tmux/tmux.conf" ]; then
      echo "üì¶ Installing tmux plugins..."
      "$XDG_CONFIG_HOME"/tmux/plugins/tpm/bin/install_plugins
    fi
    echo "‚úÖ Tmux plugin manager installed"
  fi
fi

# mise is now installed system-wide by install_system_tool function above

# Apply mise configuration BEFORE installing tools
echo "üìù Applying mise configuration..."
if chezmoi source-path >/dev/null 2>&1; then
  if chezmoi apply "$HOME/.config/mise" 2>/dev/null; then
    echo "‚úÖ Applied mise configuration from dotfiles"
  else
    # Fallback: copy mise config directly
    if [ -d "$DOTFILES_SOURCE/dot_config/mise" ]; then
      mkdir -p "$HOME/.config/mise"
      cp -r "$DOTFILES_SOURCE/dot_config/mise/"* "$HOME/.config/mise/"
      echo "‚úÖ Copied mise configuration directly"
    fi
  fi
else
  echo "‚ö†Ô∏è  Chezmoi not initialized yet, mise config will be applied later"
fi

# Install tools via mise if available
if command -v mise >/dev/null; then
  echo "üì¶ Installing development tools via mise..."

  # Install all tools from config if config exists
  if [ -f "$HOME/.config/mise/config.toml" ] || [ -f "$XDG_CONFIG_HOME/mise/config.toml" ]; then
    echo "üìã Installing tools from mise config.toml..."
    mise install
    echo "‚úÖ All mise tools installed from config"
  else
    # Fallback: install essential tools if no config found
    echo "üìã No mise config found, installing essential tools..."
    mise use -g uv@latest
    mise use -g bat@latest
    mise use -g fzf@latest
    mise use -g lsd@latest
    mise use -g ripgrep@latest
    mise use -g neovim@latest
    mise use -g node@latest
    mise use -g kubectl@latest
    mise use -g flux2@latest
    mise use -g k9s@latest
    echo "‚úÖ Essential tools installed via mise"
  fi

  # Check for critical tools and install if missing
  echo "üîç Checking for critical development tools..."

  if ! command -v nvim >/dev/null; then
    echo "üìù Installing neovim (text editor)..."
    mise use -g neovim@latest || echo "‚ö†Ô∏è  Failed to install neovim, continuing..."
  fi

  if ! command -v node >/dev/null; then
    echo "üì¶ Installing node (JavaScript runtime)..."
    mise use -g node@latest || echo "‚ö†Ô∏è  Failed to install node, continuing..."
  fi

  if ! command -v uv >/dev/null; then
    echo "üêç Installing uv (Python package manager)..."
    mise use -g uv@latest || echo "‚ö†Ô∏è  Failed to install uv, continuing..."
  fi

  if ! command -v kubectl >/dev/null; then
    echo "‚ò∏Ô∏è  Installing kubectl (Kubernetes CLI)..."
    mise use -g kubectl@latest || echo "‚ö†Ô∏è  Failed to install kubectl, continuing..."
  fi

  if ! command -v flux >/dev/null; then
    echo "üîÑ Installing flux (GitOps toolkit)..."
    mise use -g flux2@latest || echo "‚ö†Ô∏è  Failed to install flux, continuing..."
  fi

  if ! command -v k9s >/dev/null; then
    echo "üêï Installing k9s (Kubernetes TUI)..."
    mise use -g k9s@latest || echo "‚ö†Ô∏è  Failed to install k9s, continuing..."
  fi

  if ! command -v cz >/dev/null; then
    echo "üìù Installing commitizen (commit message tool)..."
    mise use -g pipx:commitizen@latest || echo "‚ö†Ô∏è  Failed to install commitizen, continuing..."
  fi

  echo "‚úÖ All critical tools checked/installed"
fi

# Install LazyVim if neovim is installed
if command -v nvim >/dev/null; then
  echo ""
  echo "üìù Setting up LazyVim configuration..."

  # Check if nvim config already exists
  if [ -d "$HOME/.config/nvim" ] && [ "$(ls -A $HOME/.config/nvim 2>/dev/null)" ]; then
    echo "‚ÑπÔ∏è  Neovim config already exists at ~/.config/nvim"
    echo "   Applying updated config from dotfiles..."

    # Apply nvim config from chezmoi/dotfiles
    if chezmoi apply "$HOME/.config/nvim" 2>/dev/null; then
      echo "‚úÖ Applied LazyVim configuration from dotfiles"
    else
      echo "‚ö†Ô∏è  Could not apply nvim config via chezmoi, trying direct copy..."
      if [ -d "$DOTFILES_SOURCE/dot_config/nvim" ]; then
        # Use . to copy hidden files too
        cp -r "$DOTFILES_SOURCE/dot_config/nvim/." "$HOME/.config/nvim/" 2>/dev/null
        echo "‚úÖ Copied LazyVim configuration from dotfiles"
      else
        echo "‚ö†Ô∏è  No nvim config found in dotfiles, skipping"
      fi
    fi
  else
    echo "üì• Installing LazyVim from dotfiles..."

    # Apply nvim config from chezmoi/dotfiles
    if chezmoi apply "$HOME/.config/nvim" 2>/dev/null; then
      echo "‚úÖ Applied LazyVim configuration from dotfiles"
    else
      echo "‚ö†Ô∏è  Could not apply via chezmoi, trying direct copy..."
      if [ -d "$DOTFILES_SOURCE/dot_config/nvim" ]; then
        mkdir -p "$HOME/.config/nvim"
        # Use . to copy hidden files too
        cp -r "$DOTFILES_SOURCE/dot_config/nvim/." "$HOME/.config/nvim/" 2>/dev/null
        echo "‚úÖ Copied LazyVim configuration from dotfiles"
      else
        echo "‚ùå No nvim config found in dotfiles"
        echo "   You can install LazyVim manually with:"
        echo "   git clone https://github.com/LazyVim/starter ~/.config/nvim"
      fi
    fi

    echo "   LazyVim will install plugins on first nvim launch"
  fi
fi

# Create necessary directories
echo "üìÅ Creating configuration directories..."

# Check if ~/.config exists before creating
if [ ! -d "$HOME/.config" ]; then
  echo ""
  echo "‚ö†Ô∏è  The ~/.config directory does not exist."
  read -p "Do you want to create it? (y/N): " -n 1 -r
  echo ""
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    mkdir -p "$HOME/.config"
    echo "‚úÖ Created ~/.config directory"
  else
    echo "‚ö†Ô∏è  Skipped creating ~/.config - some configurations may not work properly"
  fi
else
  echo "‚úÖ ~/.config directory already exists (not modified)"
fi

mkdir -p "$HOME/.local/bin"
mkdir -p "$HOME/bin"
mkdir -p "$HOME/repos"
mkdir -p "$HOME/.zfunc"  # For zsh completions (docker, kubectl, etc.)

# Handle existing shell configuration files
echo ""
echo "üìù Applying shell configuration files..."

TIMESTAMP=$(date "+%Y-%m-%d")

# Initialize chezmoi if not already done
if ! chezmoi source-path >/dev/null 2>&1; then
  echo "üîß Initializing chezmoi with source: $DOTFILES_SOURCE"
  chezmoi init --source="$DOTFILES_SOURCE"
fi

# Function to backup and apply config file
backup_and_apply() {
  local file="$1"
  local home_path="$HOME/$file"

  if [ -f "$home_path" ]; then
    backup_name="bkp_${file}"
    mv "$home_path" "$HOME/$backup_name"
    echo "üíæ Backed up existing $file to ~/$backup_name"
  fi

  # Apply from chezmoi
  echo "üîÑ Applying $file..."
  if chezmoi apply "$home_path"; then
    echo "‚úÖ Applied $file from dotfiles"
  else
    echo "‚ö†Ô∏è  chezmoi apply failed for $file, trying direct copy..."
    # Fallback: copy directly from source
    local source_file="$DOTFILES_SOURCE/dot_${file#.}"
    if [ -f "$source_file" ]; then
      cp "$source_file" "$home_path"
      echo "‚úÖ Copied $file directly from dotfiles source"
    else
      echo "‚ùå Failed to apply $file - source file not found: $source_file"
      echo "   You may need to run 'chezmoi apply' manually after setup"
    fi
  fi
}

# Function to backup and apply directory
backup_and_apply_dir() {
  local dir="$1"
  local home_path="$HOME/$dir"

  if [ -d "$home_path" ]; then
    backup_name="bkp_${dir}"
    mv "$home_path" "$HOME/$backup_name"
    echo "üíæ Backed up existing $dir to ~/$backup_name"
  fi

  # Apply from chezmoi
  echo "üîÑ Applying $dir..."
  if chezmoi apply "$home_path"; then
    echo "‚úÖ Applied $dir from dotfiles"
  else
    echo "‚ö†Ô∏è  chezmoi apply failed for $dir, trying direct copy..."
    # Fallback: copy directly from source
    local source_dir="$DOTFILES_SOURCE/dot_${dir#.}"
    if [ -d "$source_dir" ]; then
      cp -r "$source_dir" "$home_path"
      echo "‚úÖ Copied $dir directly from dotfiles source"
    else
      echo "‚ùå Failed to apply $dir - source directory not found: $source_dir"
      echo "   You may need to run 'chezmoi apply' manually after setup"
    fi
  fi
}

# Apply shell configuration files
backup_and_apply ".zshrc"
backup_and_apply ".zprofile"
backup_and_apply ".bashrc"

# Apply shell configuration directories
backup_and_apply_dir ".zfunc"

echo ""
echo "üîç Verifying shell configuration files..."

# Verify that critical files exist
VERIFICATION_FAILED=0
for file in ".zshrc" ".zprofile" ".bashrc"; do
  if [ ! -f "$HOME/$file" ]; then
    echo "‚ùå Warning: $file is missing!"
    VERIFICATION_FAILED=1
  else
    echo "‚úÖ $file is present"
  fi
done

if [ -d "$HOME/.zfunc" ]; then
  echo "‚úÖ .zfunc directory is present"
else
  echo "‚ö†Ô∏è  .zfunc directory is missing (may not be managed by chezmoi yet)"
fi

echo ""
if [ $VERIFICATION_FAILED -eq 1 ]; then
  echo "‚ö†Ô∏è  Some configuration files are missing!"
  echo "   Try running: chezmoi apply"
  echo "   Or manually copy from: $DOTFILES_SOURCE"
fi

echo ""
echo "üéâ Dotfiles setup complete!"
echo ""
echo "‚úÖ Shell configuration files (.zshrc, .zprofile, .bashrc) have been applied"
if command -v nvim >/dev/null; then
  echo "‚úÖ Neovim with LazyVim configuration has been applied"
fi
echo ""
echo "‚ö†Ô∏è  Note: Other dotfiles (config directories like tmux) have NOT been applied yet!"
echo ""
echo "To apply remaining dotfiles:"
echo "1. Review what will be changed: chezmoi diff"
echo "2. Backup your current config: cp -r ~/.config ~/.config.backup"
echo "3. Apply all remaining dotfiles: chezmoi apply"
echo ""
echo "Or apply selectively:"
echo "  chezmoi apply ~/.config/mise"
echo "  chezmoi apply ~/.config/tmux"
echo ""
echo "Next steps:"
echo "1. Restart your terminal or run: exec zsh"
echo "2. Launch neovim to complete LazyVim setup: nvim"
echo "   (LazyVim will automatically install plugins on first launch)"
echo "3. Verify installations:"
echo "   - mise list: show all installed tools"
echo "   - nvim --version: neovim text editor"
echo "   - node --version: Node.js runtime"
echo "   - uv --version: Python package manager"
echo "   - kubectl version --client: Kubernetes CLI"
echo "   - flux version: GitOps toolkit"
echo "   - k9s version: Kubernetes TUI"
echo "   - cz version: commitizen (commit message tool)"
echo "   - tmux -V: terminal multiplexer"
echo "4. Additional tools to install manually if needed:"
echo "   - docker: for containerization"
echo ""
echo "If any tool is missing, run: mise install"
echo ""

exit 0
